var Wizzaro=Wizzaro||{};Wizzaro.namespace=Wizzaro.namespace||function(a){var b,c,d=a.split("."),e=Wizzaro;for("Wizzaro"==d[0]&&(d=d.slice(1)),b=0,c=d.length;b<c;b++)"undefined"==jQuery.type(e[d[b]])&&(e[d[b]]={}),e=e[d[b]];return e},jQuery(document).ready(function(a){new Wizzaro.Plugins.Partners.v1.MetaboxElements.View.AddedElements}),Wizzaro.namespace("Plugins.Partners.v1.MetaboxElements"),Wizzaro.Plugins.Partners.v1.MetaboxElements.Config=Wizzaro.Plugins.Partners.v1.MetaboxElements.Config||{added_elements_list:{view_no_elements_template:"#wizzaro-partners-metabox-no-elements",container:"#wizzaro-partners-metabox-added-elements",elems_list:".wpme-list",add_new_elem_button:".wpme-add-bt",add_break_line_button:".wpme-add-break-line-bt",remove_elems_button:".wpme-remove-selected-bt",select_all_elems_button:".wpme-select-all",unselect_all_elems_button:".wpme-unselect-all",loader_elem:".wizzaro-spiner",element:{view_template:"#wizzaro-partners-metabox-added-element",view_break_line_template:"#wizzaro-partners-metabox-break-line-element",view_id_attr_key:"data-model-view",container:".wpme-l-elem",container_class:"wpme-l-elem",breal_line_container:"wpme-l-elem-break-line",breal_line_container_class:"wpme-l-elem-break-line",id_elem:".wpme-l-e-id",logo_elem:".wpme-l-e-logo img",name_elem:".wpme-l-e-name",select_elem_button:".wpme-l-e-select a",delete_elem_button:".wpme-l-e-del a",selected_class:"wpme-l-elem-selected",placeholder_class:"wpme-l-elem-placeholder",sortable_opatity:.7}},no_added_elements_list:{view_template:"#wizzaro-partners-metabox-noadded-elements",view_no_elements_template:"#wizzaro-partners-metabox-no-elements",view_sync_elements_template:"#wizzaro-partners-metabox-elements-sync-error",add_elements_button:".wpme-add-elements",close_button:".wizzaro-modal-close",refresh_button:".wpme-refresh",select_all_elems_button:".wpme-select-all",unselect_all_elems_button:".wpme-unselect-all",elems_list:".wpme-list",loader_elem:".wizzaro-spiner",element:{view_template:"#wizzaro-partners-metabox-noadded-element",view_id_attr_key:"data-model-view",container_class:"wpme-l-elem",container:".wpme-l-elem",id_elem:".wpme-l-e-id",logo_elem:".wpme-l-e-logo img",name_elem:".wpme-l-e-name",select_elem_button:".wpme-l-e-select a",selected_class:"wpme-l-elem-selected"}}},Wizzaro.namespace("Plugins.Partners.v1.MetaboxElements.Entity"),Wizzaro.Plugins.Partners.v1.MetaboxElements.Entity.BreakLine=Backbone.Model.extend({defaults:function(){return{select:!1,show:!0}},destroy:function(a){a=a?_.clone(a):{};var b=this,c=a.success,d=a.wait,e=function(){b.stopListening(),b.trigger("destroy",b,b.collection,a)};a.success=function(f){d&&e(),c&&c.call(a.context,b,f,a),b.isNew()||b.trigger("sync",b,f,a)};var f=!1;return _.defer(a.success),d||e(),f},select:function(){this.set("select",!0)},unselect:function(){this.set("select",!1)},toggleSelect:function(){this.get("select")===!0?this.unselect():this.select()}}),Wizzaro.namespace("Plugins.Partners.v1.MetaboxElements.Entity"),Wizzaro.Plugins.Partners.v1.MetaboxElements.Entity.Element=Backbone.Model.extend({defaults:function(){return{id:null,image_src:null,name:null,select:!1,show:!0}},destroy:function(a){a=a?_.clone(a):{};var b=this,c=a.success,d=a.wait,e=function(){b.stopListening(),b.trigger("destroy",b,b.collection,a)};a.success=function(f){d&&e(),c&&c.call(a.context,b,f,a),b.isNew()||b.trigger("sync",b,f,a)};var f=!1;return _.defer(a.success),d||e(),f},select:function(){this.set("select",!0)},unselect:function(){this.set("select",!1)},toggleSelect:function(){this.get("select")===!0?this.unselect():this.select()},show:function(){this.set("show",!0)},hide:function(){this.set("show",!1)}}),Wizzaro.namespace("Plugins.Partners.v1.MetaboxElements.Collection"),Wizzaro.Plugins.Partners.v1.MetaboxElements.Collection.Elements=Backbone.Collection.extend({model:Wizzaro.Plugins.Partners.v1.MetaboxElements.Entity.Element,getSelectedElements:function(){return this.where({select:!0,show:!0})},getShowsElements:function(){return this.where({show:!0})},getPrevShow:function(a){var b=this.indexOf(a)-1;if(b>=0)for(;b>=0;b--){var c=this.at(b);if(c.get("show")===!0)return c}},fetch:function(a){a=_.extend({parse:!0},a);var b=a.success,c=a.error,d=this;return a.success=function(e){if(_.isObject(e))if(1==e.status){var f=a.reset?"reset":"set";d[f](e.elements,a),b&&b.call(a.context,d,e.elements,a),d.trigger("sync",d,e.elements,a)}else c&&c.call(a.context,d,e,a),d.trigger("error",d,e,a);else c&&c.call(a.context,d,e,a),d.trigger("error",d,e,a)},a.error=function(b){c&&c.call(a.context,d,b,a),d.trigger("error",d,b,a)},this.sync("read",this,a)}}),Wizzaro.namespace("Plugins.Partners.v1.MetaboxElements.View"),Wizzaro.Plugins.Partners.v1.MetaboxElements.View.AddedElements=Backbone.View.extend({el:Wizzaro.Plugins.Partners.v1.MetaboxElements.Config.added_elements_list.container,config:Wizzaro.Plugins.Partners.v1.MetaboxElements.Config.added_elements_list,no_elements_template:_.template(jQuery(Wizzaro.Plugins.Partners.v1.MetaboxElements.Config.added_elements_list.view_no_elements_template).html()),collection:null,no_added_elements_modal:null,$remove_elements_button:null,$elements_list:null,$loader:null,initialize:function(){this.$remove_elements_button=this.$el.find(this.config.remove_elems_button),this.$elements_list=this.$el.find(this.config.elems_list),this.$loader=this.$el.find(this.config.loader_elem),this.$elements_list.sortable({items:"> "+this.config.element.container,placeholder:this.config.element.placeholder_class,cursor:"move",opacity:this.config.element.sortable_opatity}).disableSelection(),this.collection=new Wizzaro.Plugins.Partners.v1.MetaboxElements.Collection.Elements,jQuery.each(this.$el.find(this.config.elems_list).find(this.config.element.container),function(a,b){var c=jQuery(b);if(c.hasClass(this.config.element.breal_line_container_class)){var d=new Wizzaro.Plugins.Partners.v1.MetaboxElements.Entity.BreakLine;this.collection.add(d);new Wizzaro.Plugins.Partners.v1.MetaboxElements.View.BreakLine({el:c,model:d,config:this.config.element,use_template:!1});this.listenTo(d,"change:select",this.toggleDeleteElemsButtonVisible)}else{var d=new Wizzaro.Plugins.Partners.v1.MetaboxElements.Entity.Element({id:String(c.find(this.config.element.id_elem).val()),image_src:c.find(this.config.element.logo_elem).attr("src"),name:c.find(this.config.element.name_elem).text()});this.collection.add(d);new Wizzaro.Plugins.Partners.v1.MetaboxElements.View.Element({el:c,model:d,config:this.config.element,use_template:!1});this.listenTo(d,"change:select",this.toggleDeleteElemsButtonVisible)}}.bind(this)),this.no_added_elements_modal=new Wizzaro.Plugins.Partners.v1.MetaboxElements.View.NoAddedElements,this.no_added_elements_modal.addFilter("display_element",this.filterNoAdedDisplayElement.bind(this)),this.listenTo(this.no_added_elements_modal,"add_elements",this.addNewElements),this.listenTo(this.collection,"remove",this.checkEmptyInfo),this.listenTo(this.collection,"remove",this.toggleDeleteElemsButtonVisible),this.no_added_elements_modal.listenTo(this.collection,"remove",this.no_added_elements_modal.redisplayElement),this.$el.find(this.config.add_new_elem_button).on("click",this.openNoAddedElementsModal.bind(this)),this.$el.find(this.config.select_all_elems_button).on("click",this.selectAllElems.bind(this)),this.$el.find(this.config.unselect_all_elems_button).on("click",this.unSelectAllElems.bind(this));var a=this.$el.find(this.config.add_break_line_button);a.length>0&&a.on("click",this.addBreakLine.bind(this)),this.$remove_elements_button.on("click",this.removeSelectedElements.bind(this))},openNoAddedElementsModal:function(a){a.preventDefault(),a.stopPropagation(),this.no_added_elements_modal.open()},filterNoAdedDisplayElement:function(a,b){return!!_.isUndefined(this.collection.findWhere({id:b.get("id")}))&&a},checkEmptyInfo:function(){this.collection.length<=0&&this.$elements_list.html(this.no_elements_template())},addNewElements:function(a){this.$loader.show(),this.$elements_list.find("> "+this.config.element.container).length<=0&&this.$elements_list.html(""),_.each(a,function(a){if(_.isUndefined(this.collection.findWhere({id:a.get("id")}))){var b=new Wizzaro.Plugins.Partners.v1.MetaboxElements.Entity.Element(a.toJSON());this.collection.add(b);var c=new Wizzaro.Plugins.Partners.v1.MetaboxElements.View.Element({model:b,config:this.config.element});this.listenTo(b,"change:select",this.toggleDeleteElemsButtonVisible),this.$elements_list.append(c.$el)}}.bind(this)),this.$elements_list.sortable("refresh"),this.checkEmptyInfo(),this.$loader.hide()},addBreakLine:function(){this.$elements_list.find("> "+this.config.element.container).length<=0&&this.$elements_list.html("");var a=new Wizzaro.Plugins.Partners.v1.MetaboxElements.Entity.BreakLine;this.collection.add(a);var b=new Wizzaro.Plugins.Partners.v1.MetaboxElements.View.BreakLine({model:a,config:this.config.element});this.listenTo(a,"change:select",this.toggleDeleteElemsButtonVisible),this.$elements_list.append(b.$el),this.$elements_list.sortable("refresh"),this.checkEmptyInfo()},toggleDeleteElemsButtonVisible:function(){this.collection.getSelectedElements().length>0?this.$remove_elements_button.attr("disabled",!1):this.$remove_elements_button.attr("disabled",!0)},selectAllElems:function(a){a.preventDefault(),a.stopPropagation(),this.collection.invoke("select")},unSelectAllElems:function(a){a.preventDefault(),a.stopPropagation(),this.collection.invoke("unselect")},removeSelectedElements:function(a){a.preventDefault(),a.stopPropagation();var b=this.collection.getSelectedElements();b.length>0&&confirm(wpWizzaroPartnersMetaboxElementsConfig.l10n.delete_elements)&&_.invoke(b,"destroy")}}),Wizzaro.namespace("Plugins.Partners.v1.MetaboxElements.View"),Wizzaro.Plugins.Partners.v1.MetaboxElements.View.BreakLine=Backbone.View.extend({config:null,template:null,initialize:function(a){this.config=a.config,this.template=_.template(jQuery(this.config.view_break_line_template).html()),this.render(a.use_template),this.$el.attr(this.config.view_id_attr_key,this.model.get("id")),this.listenTo(this.model,"change:select",this.markSelected),this.listenTo(this.model,"destroy",this.destroyModel)},render:function(a){a!==!1&&(this.$el.addClass(this.config.container_class),this.$el.addClass(this.config.breal_line_container_class),this.$el.html(this.template(this.model.toJSON()))),this.$el.find(this.config.select_elem_button).on("click",this.select.bind(this));var b=this.$el.find(this.config.delete_elem_button);b.length>0&&this.$el.find(this.config.delete_elem_button).on("click",this.delete.bind(this))},select:function(a){a.preventDefault(),a.stopPropagation(),this.model.toggleSelect()},markSelected:function(){this.model.get("select")===!0?this.$el.addClass(this.config.selected_class):this.$el.removeClass(this.config.selected_class)},delete:function(a){a.preventDefault(),a.stopPropagation(),confirm(wpWizzaroPartnersMetaboxElementsConfig.l10n.delete_element)&&this.model.destroy()},destroyModel:function(){this.remove()}}),Wizzaro.namespace("Plugins.Partners.v1.MetaboxElements.View"),Wizzaro.Plugins.Partners.v1.MetaboxElements.View.Element=Backbone.View.extend({config:null,template:null,initialize:function(a){this.config=a.config,this.template=_.template(jQuery(this.config.view_template).html()),this.render(a.use_template),this.$el.attr(this.config.view_id_attr_key,this.model.get("id")),this.listenTo(this.model,"change:select",this.markSelected),this.listenTo(this.model,"change:show",this.changeShow),this.listenTo(this.model,"change:id",this.render),this.listenTo(this.model,"change:name",this.render),this.listenTo(this.model,"change:image_src",this.render),this.listenTo(this.model,"destroy",this.destroyModel)},render:function(a){a!==!1&&(this.$el.addClass(this.config.container_class),this.$el.html(this.template(this.model.toJSON()))),this.$el.find(this.config.select_elem_button).on("click",this.select.bind(this));var b=this.$el.find(this.config.delete_elem_button);b.length>0&&this.$el.find(this.config.delete_elem_button).on("click",this.delete.bind(this))},select:function(a){a.preventDefault(),a.stopPropagation(),this.model.toggleSelect()},markSelected:function(){this.model.get("select")===!0?this.$el.addClass(this.config.selected_class):this.$el.removeClass(this.config.selected_class)},changeShow:function(){this.model.get("show")===!1&&this.remove()},delete:function(a){a.preventDefault(),a.stopPropagation(),confirm(wpWizzaroPartnersMetaboxElementsConfig.l10n.delete_element)&&this.model.destroy()},destroyModel:function(){this.remove()}}),Wizzaro.namespace("Plugins.Partners.v1.MetaboxElements.View"),Wizzaro.Plugins.Partners.v1.MetaboxElements.View.NoAddedElements=Backbone.View.extend({collection:null,$add_elements_button:null,$elements_list:null,$loader:null,config:Wizzaro.Plugins.Partners.v1.MetaboxElements.Config.no_added_elements_list,filters:{display_element:[],display_elements:[]},template:_.template(jQuery(Wizzaro.Plugins.Partners.v1.MetaboxElements.Config.no_added_elements_list.view_template).html()),no_elements_template:_.template(jQuery(Wizzaro.Plugins.Partners.v1.MetaboxElements.Config.no_added_elements_list.view_no_elements_template).html()),sync_elements_template:_.template(jQuery(Wizzaro.Plugins.Partners.v1.MetaboxElements.Config.no_added_elements_list.view_sync_elements_template).html()),attributes:{class:"wizzaro-modal-container"},initialize:function(){this.collection=new Wizzaro.Plugins.Partners.v1.MetaboxElements.Collection.Elements,this.collection.url=ajaxurl,this.render(),jQuery("body").append(this.$el)},render:function(){return this.$el.html(this.template()),this.$add_elements_button=this.$el.find(this.config.add_elements_button),this.$elements_list=this.$el.find(this.config.elems_list),this.$loader=this.$el.find(this.config.loader_elem),jQuery(document).on("keydown",this.eventKeyDown.bind(this)),this.$add_elements_button.on("click",this.addElements.bind(this)),this.$el.find(this.config.close_button).on("click",this.close.bind(this)),this.$el.find(this.config.refresh_button).on("click",this.updateCollection.bind(this)),this.$el.find(this.config.select_all_elems_button).on("click",this.selectAllElems.bind(this)),this.$el.find(this.config.unselect_all_elems_button).on("click",this.unSelectAllElems.bind(this)),this.listenTo(this.collection,"add",this.addNewElement),this.listenTo(this.collection,"remove",this.checkEmptyInfo),this},open:function(){jQuery("body").css("overflow","hidden"),this.collection.length<=0&&this.updateCollection(),this.$el.show()},close:function(){jQuery("body").css("overflow",""),this.$el.hide()},eventKeyDown:function(){27==event.keyCode&&this.$el.is(":visible")&&(event.preventDefault(),event.stopPropagation(),this.close())},addFilter:function(a,b){_.isArray(this.filters[a])&&_.isFunction(b)&&this.filters[a].push(b)},checkEmptyInfo:function(){this.collection.getShowsElements().length<=0&&this.$elements_list.html(this.no_elements_template())},updateCollection:function(){this.$loader.show(),this.collection.fetch({type:"post",data:{action:wpWizzaroPartnersMetaboxElementsConfig.sync_elements.action,nounce:wpWizzaroPartnersMetaboxElementsConfig.sync_elements.nonce,elements_post_type:wpWizzaroPartnersMetaboxElementsConfig.sync_elements.elements_post_type},error:function(){this.collection.reset(),this.$elements_list.html(this.sync_elements_template())}.bind(this),success:function(a,b){this.checkEmptyInfo()}.bind(this),complete:function(){this.$loader.hide()}.bind(this)})},addNewElement:function(a){this.listenTo(a,"change:show",this.displayElement),this.listenTo(a,"change:show",this.checkEmptyInfo),this.listenTo(a,"change:select",this.toggleAddButtonVisible),this.displayElement(a)},displayElement:function(a){var b=!0;if(_.each(this.filters.display_element,function(c){b=c(b,a)}),a.set("show",b),a.get("show")===!0){this.$elements_list.find("> "+this.config.element.container).length<=0&&this.$elements_list.html("");var c=new Wizzaro.Plugins.Partners.v1.MetaboxElements.View.Element({model:a,config:this.config.element}),d=this.collection.getPrevShow(a);if(_.isUndefined(d))this.$elements_list.append(c.$el);else{var e=this.$elements_list.find(this.config.element.container+"["+this.config.element.view_id_attr_key+"="+d.get("id")+"]");e.length>0?e.after(c.$el):this.$elements_list.append(c.$el)}}},selectAllElems:function(a){a.preventDefault(),a.stopPropagation(),this.collection.invoke("select")},unSelectAllElems:function(a){a.preventDefault(),a.stopPropagation(),this.collection.invoke("unselect")},toggleAddButtonVisible:function(){this.collection.getSelectedElements().length>0?this.$add_elements_button.attr("disabled",!1):this.$add_elements_button.attr("disabled",!0)},addElements:function(a){a.preventDefault(),a.stopPropagation();var b=this.collection.getSelectedElements();this.collection.invoke("unselect"),this.trigger("add_elements",b),this.close(),_.invoke(b,"hide")},redisplayElement:function(a){if(a.has("id")){var b=this.collection.findWhere({id:a.get("id")});_.isUndefined(b)||b.show()}}});